# Docker Telegram Autoscaler Bot

Телеграм‑бот для управления Docker‑контейнерами и автоскейлинга в стеке `docker compose`.

## Возможности

- Авторизация по `chat_id` (только разрешённые пользователи могут управлять контейнерами).
- Просмотр списка контейнеров с цветовым статусом (Up / Created / Exited).
- Получение логов контейнера в виде текстового файла.
- Старт, стоп, рестарт и удаление контейнеров.
- Создание нового контейнера из произвольного образа.
- Масштабирование сервиса.
- Автоматический скейлинг по среднему CPU выбранного сервиса.

## Стек

- Python 3.12  
- python‑telegram‑bot  
- aiodocker  
- Docker / Docker Compose v2  
- pytest  

## Структура проекта
```
docker-tg-bot/
├── Dockerfile
├── docker-compose.yml
├── pyproject.toml
├── README.md
├── requirements.txt
├── bot/
│   ├── config.py
│   ├── docker_client.py
│   ├── handlers.py
│   ├── main.py
│   └── monitor.py
└── tests/
    ├── test_docker_client.py
    ├── test_handlers.py
    └── test_monitor.py
```
## Конфигурация

Бот настраивается через переменные окружения:

- `TELEGRAM_TOKEN` — токен бота (обязателен).  
- `TELEGRAM_ALLOWED_CHATS` — список разрешённых chat_id через запятую, например `12345,67890`.  
- `AUTOSCALE_INTERVAL` — интервал проверки нагрузки в секундах (по умолчанию `30`).  
- `CPU_THRESHOLD` — порог загрузки CPU для масштабирования (по умолчанию `0.7` = 70 %).  
- `MAX_REPLICAS` — максимальное число реплик сервиса (по умолчанию `5`).  
- `MIN_REPLICAS` — минимальное число реплик (по умолчанию `1`).  
- `COMPOSE_PROJECT` — имя проекта docker compose (по умолчанию `my_stack`).  
- `COMPOSE_SERVICE` — имя сервиса для скейлинга (по умолчанию `web`).  

## Сборка и запуск

1. Установить Docker и Docker Compose v2 на хост.  
2. В корне проекта задать переменные окружения (через `.env` или экспортом в shell).  
3. Собрать и запустить контейнер бота:

```docker compose up --build```

Контейнер бота должен иметь доступ к `/var/run/docker.sock`, чтобы управлять Docker Engine хоста.

## Команды бота

После старта бота отправьте в чат команду `/start` — он выведет краткую справку.

- `/start` — показать список доступных команд.  
- `/list` — список контейнеров с цветовым статусом и временем работы.  
- `/logs <name>` — отправить последние логи контейнера в виде файла.  
- `/startc <name>` — запустить контейнер.  
- `/stopc <name>` — остановить контейнер.  
- `/restartc <name>` — перезапустить контейнер.  
- `/rmc <name>` — удалить контейнер (force).  
- `/new <image> [name]` — создать новый контейнер из заданного образа.  
- `/scale <n>` — масштабировать сервис в compose‑проекте до `n` реплик.  

Команды выполняются только для пользователей с `chat_id`, указанными в `TELEGRAM_ALLOWED_CHATS`.

## Тесты

Для запуска юнит‑тестов:

cd docker-tg-bot
python3 -m pytest

В набор входят:

- тест клиента Docker (`test_docker_client.py`);
- тест обработчиков команд (`test_handlers.py`);
- тест автоскейлера (`test_monitor.py`).

Все ключевые части логики покрыты базовыми проверками, что упрощает рефакторинг и сопровождение проекта.

